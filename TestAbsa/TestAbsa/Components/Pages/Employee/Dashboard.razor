@page "/employee/dashboard"
@layout TestAbsa.Components.Layout.MainLayout
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using TestAbsa.Data
@using TestAbsa.Data.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="container mt-4">
    <!-- Task & Stock Warning Section -->
    <div class="row mb-4">
        <!-- Today's Task -->
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h5>Today's Task</h5>
                <div class="text-muted">No tasks assigned yet.</div>
            </div>
        </div>

        <!-- Stock Warning -->
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h5>Stock Warning</h5>

                @if (isLoading)
                {
                    <div class="text-muted">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Loading stock warnings...
                    </div>
                }
                else if (lowStockProducts.Any())
                {
                    <ul class="list-unstyled mb-0">
                        @foreach (var product in lowStockProducts)
                        {
                            <li class="mb-2">
                                @if (product.StockLevel == "critical")
                                {
                                    <span class="text-danger">🔴</span>
                                }
                                else
                                {
                                    <span class="text-warning">⚠️</span>
                                }

                                <strong>@product.Name</strong> —
                                <span class="@(product.StockLevel == "critical" ? "text-danger" : "text-warning")">
                                    @product.StockLevel (@product.CurrentStock units)
                                </span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-success">
                        ✅ All products are well stocked!
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<LowStockProduct> lowStockProducts = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadLowStockProducts();
    }

    private async Task LoadLowStockProducts()
    {
        try
        {
            isLoading = true;
            using var context = await DbContextFactory.CreateDbContextAsync();

            lowStockProducts = await context.Products
                .Where(p => p.CurrentStock <= p.MinLevel)
                .OrderBy(p => p.CurrentStock)
                .Select(p => new LowStockProduct
                {
                    Name = p.ItemName,
                    CurrentStock = p.CurrentStock,
                    MinLevel = p.MinLevel,
                    StockLevel = p.CurrentStock == 0 ? "out of stock"
                              : p.CurrentStock <= (p.MinLevel * 0.5) ? "critical"
                              : "low"
                })
                .Take(10)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading low stock products: {ex.Message}");
            lowStockProducts = new List<LowStockProduct>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private class LowStockProduct
    {
        public string Name { get; set; } = "";
        public int CurrentStock { get; set; }
        public int MinLevel { get; set; }
        public string StockLevel { get; set; } = "";
    }
}
